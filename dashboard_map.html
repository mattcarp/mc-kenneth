<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kenneth â€” AIS Vessel Tracker & Voice Correlation</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Courier New', monospace;
      background: #0d1117;
      color: #c9d1d9;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    header h1 { font-size: 1.1rem; color: #58a6ff; }
    header .subtitle { font-size: 0.75rem; color: #8b949e; }

    .status-bar {
      margin-left: auto;
      display: flex;
      gap: 16px;
      font-size: 0.75rem;
      align-items: center;
    }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }
    .dot-green { background: #3fb950; animation: pulse 2s infinite; }
    .dot-orange { background: #f78166; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #map {
      flex: 1;
      background: #0d1117;
    }

    .sidebar {
      width: 320px;
      background: #161b22;
      border-left: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-section {
      border-bottom: 1px solid #30363d;
      padding: 12px 16px;
    }

    .sidebar-section h2 {
      font-size: 0.8rem;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }

    .vessel-list {
      flex: 1;
      overflow-y: auto;
    }

    .vessel-card {
      padding: 10px 16px;
      border-bottom: 1px solid #21262d;
      cursor: pointer;
      transition: background 0.15s;
    }

    .vessel-card:hover { background: #1c2128; }
    .vessel-card.correlated { border-left: 3px solid #f78166; }

    .vessel-name {
      font-size: 0.85rem;
      color: #e6edf3;
      font-weight: bold;
    }

    .vessel-meta {
      font-size: 0.72rem;
      color: #8b949e;
      margin-top: 2px;
    }

    .corr-badge {
      display: inline-block;
      background: #f78166;
      color: #0d1117;
      font-size: 0.65rem;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 6px;
      font-weight: bold;
    }

    .voice-list {
      flex: 0 0 auto;
      max-height: 200px;
      overflow-y: auto;
    }

    .voice-card {
      padding: 8px 16px;
      border-bottom: 1px solid #21262d;
      font-size: 0.72rem;
    }

    .voice-card .ts { color: #8b949e; }
    .voice-card .freq { color: #58a6ff; }

    .stat { display: flex; justify-content: space-between; font-size: 0.75rem; margin: 3px 0; }
    .stat-val { color: #58a6ff; }

    #refresh-countdown {
      font-size: 0.72rem;
      color: #8b949e;
    }

    /* Leaflet custom markers */
    .vessel-icon {
      background: #1f6feb;
      border: 2px solid #58a6ff;
      border-radius: 50%;
      width: 14px !important;
      height: 14px !important;
      margin-left: -7px !important;
      margin-top: -7px !important;
    }

    .vessel-icon.correlated {
      background: #f78166;
      border-color: #ff7b72;
    }

    .voice-icon {
      background: #388bfd22;
      border: 2px dashed #388bfd;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>ðŸš¢ Kenneth â€” AIS Vessel Tracker</h1>
    <div class="subtitle">Malta / Central Mediterranean Â· pyais decoder</div>
  </div>
  <div class="status-bar">
    <span><span class="status-dot dot-green"></span>Live</span>
    <span id="vessel-count">â€”</span>
    <span id="refresh-countdown">Refresh in 10s</span>
  </div>
</header>

<div class="main">
  <div id="map"></div>

  <div class="sidebar">
    <!-- Stats -->
    <div class="sidebar-section">
      <h2>Overview</h2>
      <div class="stat"><span>Vessels tracked</span><span class="stat-val" id="stat-vessels">â€”</span></div>
      <div class="stat"><span>Correlated captures</span><span class="stat-val" id="stat-correlated">â€”</span></div>
      <div class="stat"><span>Voice captures</span><span class="stat-val" id="stat-voices">â€”</span></div>
      <div class="stat"><span>Last update</span><span class="stat-val" id="stat-updated">â€”</span></div>
    </div>

    <!-- Voice Captures -->
    <div class="sidebar-section">
      <h2>Recent Voice Captures</h2>
    </div>
    <div class="voice-list" id="voice-list">
      <div class="voice-card" style="color:#8b949e;font-size:0.72rem;padding:12px 16px;">
        No voice captures loaded. API at /voice/speakers returns profiles.
      </div>
    </div>

    <!-- Vessel List -->
    <div class="sidebar-section">
      <h2>Vessels</h2>
    </div>
    <div class="vessel-list" id="vessel-list">
      <div style="padding:12px 16px;color:#8b949e;font-size:0.75rem;">Loadingâ€¦</div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE      = window.location.origin;
const AIS_URL       = `${API_BASE}/maritime/ais`;
const ALERTS_URL    = `${API_BASE}/alerts?limit=50`;
const REFRESH_MS    = 10_000;
const CORR_TIME_MIN = 5;          // minutes for voiceâ†’vessel time window
const CORR_DIST_KM  = 50;         // km for voiceâ†’vessel distance window

// â”€â”€ Map Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl: true }).setView([35.9, 14.51], 9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 18,
}).addTo(map);

// Leaflet layer groups
const vesselLayer = L.layerGroup().addTo(map);
const voiceLayer  = L.layerGroup().addTo(map);

// â”€â”€ Haversine distance (km) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// â”€â”€ Voice capture store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Populated from /alerts â€” we treat marine-VHF alerts as voice proxies.
let voiceCaptures = [];

async function fetchVoiceCaptures() {
  try {
    const r = await fetch(ALERTS_URL);
    if (!r.ok) return;
    const data = await r.json();
    // Filter alerts tagged as marine voice captures
    voiceCaptures = (data.alerts || []).filter(a =>
      a.signal_type === 'marine_vhf' || (a.tags || []).includes('voice')
    ).map(a => ({
      id: a.id,
      timestamp: new Date(a.timestamp),
      freq_mhz: a.frequency_mhz,
      title: a.title,
      lat: a.lat ?? null,   // may not be present
      lon: a.lon ?? null,
    }));
  } catch (_) {
    // API unavailable â€” leave voiceCaptures as-is
  }
}

// â”€â”€ Correlation logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function correlate(vessel, captures) {
  if (!vessel.lat || !vessel.lon) return [];
  const vesselTime = new Date(vessel.timestamp);
  return captures.filter(cap => {
    const timeDiff = Math.abs(vesselTime - cap.timestamp) / 60000; // minutes
    if (timeDiff > CORR_TIME_MIN) return false;
    if (cap.lat && cap.lon) {
      const dist = haversine(vessel.lat, vessel.lon, cap.lat, cap.lon);
      return dist <= CORR_DIST_KM;
    }
    // If no position on capture, time-only correlation still flags it
    return timeDiff <= CORR_TIME_MIN;
  });
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderVessels(vessels) {
  vesselLayer.clearLayers();
  const listEl = document.getElementById('vessel-list');
  listEl.innerHTML = '';

  let corrCount = 0;

  vessels.forEach(v => {
    if (v.lat == null || v.lon == null) return;

    const corr = correlate(v, voiceCaptures);
    const isCorr = corr.length > 0;
    if (isCorr) corrCount++;

    // Map marker
    const icon = L.divIcon({
      className: '',
      html: `<div class="vessel-icon${isCorr ? ' correlated' : ''}"></div>`,
      iconSize: [14, 14],
    });

    const popup = `
      <b>${v.name}</b><br/>
      MMSI: ${v.mmsi}<br/>
      ${v.speed_knots != null ? `Speed: ${v.speed_knots.toFixed(1)} kn` : ''}<br/>
      ${v.course != null ? `Course: ${v.course.toFixed(0)}Â°` : ''}<br/>
      ${v.nav_status ? `Status: ${v.nav_status}` : ''}<br/>
      ${isCorr ? `<span style="color:#f78166">âš  ${corr.length} voice capture(s) nearby</span>` : ''}
      <br/><small>${v.timestamp}</small>
    `;

    L.marker([v.lat, v.lon], { icon })
      .bindPopup(popup)
      .addTo(vesselLayer);

    // Sidebar card
    const card = document.createElement('div');
    card.className = `vessel-card${isCorr ? ' correlated' : ''}`;
    card.innerHTML = `
      <div class="vessel-name">
        ${v.name}
        ${isCorr ? `<span class="corr-badge">VOICE Ã—${corr.length}</span>` : ''}
      </div>
      <div class="vessel-meta">
        MMSI ${v.mmsi} Â·
        ${v.lat.toFixed(4)}Â°N ${v.lon.toFixed(4)}Â°E Â·
        ${v.speed_knots != null ? v.speed_knots.toFixed(1) + ' kn' : 'â€”'}
      </div>
    `;
    card.onclick = () => map.setView([v.lat, v.lon], 12);
    listEl.appendChild(card);
  });

  document.getElementById('stat-vessels').textContent = vessels.length;
  document.getElementById('stat-correlated').textContent = corrCount;
  document.getElementById('vessel-count').textContent = `${vessels.length} vessels`;
}

function renderVoiceCaptures() {
  const listEl = document.getElementById('voice-list');
  listEl.innerHTML = '';
  document.getElementById('stat-voices').textContent = voiceCaptures.length;

  if (!voiceCaptures.length) {
    listEl.innerHTML = `<div class="voice-card" style="color:#8b949e;">No marine-VHF captures in alert log.</div>`;
    return;
  }

  voiceCaptures.slice(0, 20).forEach(cap => {
    const card = document.createElement('div');
    card.className = 'voice-card';
    card.innerHTML = `
      <div class="freq">ðŸ“» ${cap.freq_mhz ? cap.freq_mhz.toFixed(3) + ' MHz' : 'Marine VHF'}</div>
      <div>${cap.title}</div>
      <div class="ts">${cap.timestamp.toISOString().replace('T',' ').slice(0,19)} UTC</div>
    `;
    listEl.appendChild(card);
  });
}

// â”€â”€ Main refresh loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh() {
  try {
    const [aisRes] = await Promise.all([
      fetch(AIS_URL),
      fetchVoiceCaptures(),
    ]);

    if (aisRes.ok) {
      const data = await aisRes.json();
      renderVessels(data.vessels || []);
      renderVoiceCaptures();
      document.getElementById('stat-updated').textContent =
        new Date().toISOString().slice(11, 19) + ' UTC';
    }
  } catch (e) {
    console.warn('AIS fetch failed:', e);
  }
}

// Countdown timer
let countdown = REFRESH_MS / 1000;
setInterval(() => {
  countdown--;
  if (countdown <= 0) {
    countdown = REFRESH_MS / 1000;
    refresh();
  }
  document.getElementById('refresh-countdown').textContent =
    `Refresh in ${countdown}s`;
}, 1000);

// Initial load
refresh();
</script>
</body>
</html>
